{% extends 'lk_base.html' %}

{% block add_to_head %}

    <!-- Форматирование дат -->
    <script type="text/javascript" src="{{ STATIC_URL }}libs/moment/moment.min.js"></script>

    <!-- Вспомогательные разные функции -->
    <script src="{{ STATIC_URL }}js/uu_utils.js"></script>

{% endblock %}


{% block ana_active %} class="active"{% endblock %}

{% block lk_content %}

    <script>


        /* Класс объединяет в себе код, предназначенный для обращения на сервер, загрузке ответа с сервера,
           и установке флага успешности загрузки: успешно загрузили или была ошибка.
        */
        function FromServerLoader(serverApiUrl, $http, postData){

            var self = this;

            // Метод начала загрузки
            this.load = function(serverApiUrl, $http, postData){
                self.api = undefined;
                self._isSuccessFlag = false;
                self._isErrorFlag = false;
                self._serverErrorCode = 0;
                var httpMethod = function(url){
                    if (postData){
                        return $http.post(url, postData);
                    }
                    else{
                        return $http.get(url);
                    }
                };
                httpMethod(serverApiUrl).
                    success(function(data) {
                        self.api = data;
                        self._isSuccessFlag = true;
                    }).error(function(data, code){
                        self._isErrorFlag = true;

                        // Если отпал инет или отменена загрузка (клик по ссылке) или упал сервер то код будет 0
                        self._serverErrorCode = code;
                    });
            }
            // Выдает true пока ждем ответ от сервера
            this.isLoading = function(){
                return (!self._isErrorFlag && ! self._isSuccessFlag);
            }
            // Выдает true когда получен 200 ответ от сервера
            this.isSuccess = function(){
                return self._isSuccessFlag;
            }
            // Выдает true когда ответ от сервера не получен
            this.isUnknownError = function(){
                return self._isErrorFlag && (self._serverErrorCode == 0);
            }
            // Выдает true когда от сервера получен ответ с кодом ошибки
            this.isServerError = function(){
                return self._isErrorFlag && (self._serverErrorCode != 0);
            }

            // Начальная загрузка
            this.load(serverApiUrl, $http, postData);
        }


        // ПЕреход на страницу анализа с указанными типом анализа, периодом, группировкой.
        // Если они не указаны (undefined), тогда взять их из УРЛ. Если в урл их нет,
        // тогда они будут по-умолчанию.
        function goToAnaUrl(type, period, grouping){
            return goToUchOrAnaUrl(type, period, grouping, true)
        }

        function AnaController($scope, $http){

            // какие открыть в таблице
            $scope.periodCode = '{{ lka_period }}';
            $scope.anaType = '{{ lka_type }}';
            $scope.ac_is_grouping = '{{ lka_is_grouping }}' == 'True';

            // Тут получаем с сервера данные в формате
            // pageData {
            //     'dataRows': {
            //         'rashod-week': ...
            //         'rashod-month': ...
            //         'dohod-week': ...
            //         ....
            //     },
            //     ...
            // }

            // Версия в контроллере
            $scope.acGoToAnaUrl = function(type, period, grouping_switch){

                // Возвращает строку для передачи в урл в зависимости от значения чекбокса
                if (grouping_switch){
                    $scope.ac_is_grouping = !$scope.ac_is_grouping;
                }
                var grouping = $scope.ac_is_grouping ? 'group' : 'nogroup';

                // переход
                return goToAnaUrl(type, period, grouping);
            };

            // Загрузка данных с сервера
            $scope.load = function(){
                $scope.loader = new FromServerLoader('/ajax_lk_ana/', $http, {
                    periodCode: $scope.periodCode,
                    anaType: $scope.anaType,
                    lkax_is_grouping: $scope.ac_is_grouping
                });
            };
            $scope.load();

            $scope.getDataRowList = function(){
                return $scope.loader.api.pageData['dataRows'][$scope.anaType + '-' + $scope.periodCode]
            };
            $scope.getTotalRow = function(){
                return $scope.loader.api.pageData['totalRow'][$scope.anaType + '-' + $scope.periodCode];
            };
            $scope.getPeriods = function(){
                return $scope.loader.api.pageData['periods'][$scope.anaType + '-' + $scope.periodCode];
            };
            $scope.getCatCaption = function(){
                return "Категории"
            };
            $scope.getTotCaption = function(){
                return $scope.anaType == 'rashod' ? "Расходы всего" : "Доходы всего"
            };
        }
    </script>

    <style>

        {# Стиль ссылки с суммы в таблице анализа #}
        .lka_sum_link{
            color: black;
        }
        .lka_sum_link:hover{
            color: red;
        }
    </style>

    <div ng-controller="AnaController">

        <!-- Выбор группировки -->
        <h5 style="display: inline;">Анализ </h5>
        <div style="padding-bottom: 7px; display: inline-block; position: relative; top:0px; padding-left: 12px;" ng-cloak>

            <button type="button" class="btn btn-default" ng-class="{active: anaType=='rashod'}" ng-click="acGoToAnaUrl('rashod', undefined, undefined)">расходов</button>
            <button type="button" class="btn btn-default" ng-class="{active: anaType=='dohod'}" ng-click="acGoToAnaUrl('dohod', undefined, undefined)">доходов</button>

        </div>
        <h5 style="display: inline; padding-left: 20px;">По периодам</h5>
        <div style="padding-bottom: 7px; display: inline-block; position: relative; padding-left: 12px;" ng-cloak>

            <button type="button" class="btn btn-default" ng-class="{active: periodCode=='day'}" ng-click="acGoToAnaUrl(undefined, 'day', undefined)">день</button>
            <button type="button" class="btn btn-default" ng-class="{active: periodCode=='week'}" ng-click="acGoToAnaUrl(undefined, 'week', undefined)">неделя</button>
            <button type="button" class="btn btn-default" ng-class="{active: periodCode=='month'}" ng-click="acGoToAnaUrl(undefined, 'month', undefined)">месяц</button>
            <button type="button" class="btn btn-default" ng-class="{active: periodCode=='quart'}" ng-click="acGoToAnaUrl(undefined, 'quart', undefined)">квартал</button>

        </div>
        <style>
            .sili_help_icon{
                display: inline-block;
                height: 18px;
                width: 18px;
                background: url(/static/img/sili_tooltip.png) no-repeat;
                position: relative;
                top: 5px;
            }
            .tooltip-inner {
                max-width: 630px;
                text-align: left;
            }
        </style>
        <div class="form-group" style="display: inline-block; padding-left: 20px; margin-bottom: 0px;">
            <div class="checkbox" style="margin-top: 0px;">
                <label>
                    <input style="position: relative; top: 3px;" type="checkbox" ng-model="ac_is_grouping" ng-click="acGoToAnaUrl(undefined, undefined, true)">
                    <span>группировка</span>
                </label>
                <span ng-controller='SiliTooltipCtrl2' title='Позволяет объединить несколько категорий в таблице в одну при отображении, для облегчения анализа. Для этого в качестве названия группы берётся часть названия категории, находящаяся перед первым двойным дефисом. Например, у Вас есть категория "Еда -- Столовая" и "Еда -- Магазин". Тогда при клике на галочку эти две категории объединятся в одну с названием "Еда".' class="sili_help_icon"></span>
            </div>
        </div>

        <div ng-cloak>

            <div ng-if="loader.isLoading()" class="alert alert-warning">
                Загрузка данных с сервера, подождите, пожалуйста, до 30 секунд...
            </div>
            <div ng-if="loader.isSuccess()">

                <!-- Таблица с периодами, категориями, суммами -->
                <table class="table table-hover table-condensed table-bordered" style="width: auto;" ng-cloak>
                    <thead>
                        <tr>
                            <th style="background-color: #f0f0f0; width: 200px; text-align: center;">{$ getCatCaption() $}</th>

                            {# ширина 101 подобрана чтобы недели входили, например, неделя 13 2016 года - длинный текст #}
                            <th style="background-color: #f0f0f0; width: 101px; text-align: center;" ng-repeat="p in getPeriods()">
                                {$ p.first $}<br /><span style="font-weight: normal;">{$ p.second $}</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-show="getDataRowList().length == 0">
                            <td colspan="7" style="text-align: center; padding: 50px;">Нет операций для отобржения. Начните вести учет на вкладке "Учет".</td>
                        </tr>
                        <tr ng-repeat="row in getDataRowList()">
                            <td style="background-color: #f0f0f0; ">
                                <div ng-controller='SiliTooltipCtrl2' style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 200px;">{$ row.category $}</div>
                            </td>
                            <td ng-repeat="i in row.lka_cell_data track by $index" style="text-align: right;">
                                <a
                                        href="/lk/{$ i.lka_cell_period $}/None/{$ row.lka_category_id $}/"
                                        class="lka_sum_link"

                                        {# Проход к учету возможен только без группировки #}
                                        {% if lka_is_grouping %}
                                            onclick="alert('Включена группировка. Переход к учету при клике на сумму возможен только при отключенной группировке. Отключите группировку, пожалуйста, и повторите попытку.'); return false;"
                                        {% endif %}
                                        >
                                    {$ i.lka_cell_val $}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <td style="background-color: #f0f0f0; font-weight: bold; text-align: right;">
                                <span>{$ getTotCaption() $}</span>
                            </td>
                            <td ng-repeat="i in getTotalRow() track by $index" style="background-color: #f0f0f0; text-align: right; font-weight: bold;">{$ i $}</td>
                        </tr>
                    </tbody>
                </table>

            </div>
            <div ng-if="loader.isUnknownError()" class="alert alert-danger">
                Нет связи с сервером. Повторите попытку позже, пожалуйста, или обратитесь в службу поддержки.
            </div>
            <div ng-if="loader.isServerError()" class="alert alert-danger">
                Ошибка на сервере. Повторите попытку позже, пожалуйста, или обратитесь в службу поддержки.
            </div>

        </div>


    </div>

{% endblock %}