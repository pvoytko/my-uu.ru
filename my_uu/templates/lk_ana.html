{% extends 'lk_base.html' %}
{% load pvl_angular %}


{% block add_to_head %}

    <!-- Форматирование дат -->
    <script type="text/javascript" src="/static/libs/moment/moment.min.js"></script>

    <!-- Вспомогательные разные функции -->
    <script src="/static/js/uu_utils.js"></script>

{% endblock %}


{% block ana_active %} class="active"{% endblock %}

{% block lk_wide_content %}

    <script>


        /* Класс объединяет в себе код, предназначенный для обращения на сервер, загрузке ответа с сервера,
           и установке флага успешности загрузки: успешно загрузили или была ошибка.
        */
        function FromServerLoader(serverApiUrl, $http, postData){

            var self = this;

            // Метод начала загрузки
            this.load = function(serverApiUrl, $http, postData){
                self.api = undefined;
                self._isSuccessFlag = false;
                self._isErrorFlag = false;
                self._serverErrorCode = 0;
                var httpMethod = function(url){
                    if (postData){
                        return $http.post(url, postData);
                    }
                    else{
                        return $http.get(url);
                    }
                };
                httpMethod(serverApiUrl).
                    then(
                        function(data) {
                            self.api = data.data;
                            self._isSuccessFlag = true;
                        },
                        function(data, code){
                            self._isErrorFlag = true;

                            // Если отпал инет или отменена загрузка (клик по ссылке) или упал сервер то код будет 0
                            self._serverErrorCode = code;
                        }
                    );
            }
            // Выдает true пока ждем ответ от сервера
            this.isLoading = function(){
                return (!self._isErrorFlag && ! self._isSuccessFlag);
            }
            // Выдает true когда получен 200 ответ от сервера
            this.isSuccess = function(){
                return self._isSuccessFlag;
            }
            // Выдает true когда ответ от сервера не получен
            this.isUnknownError = function(){
                return self._isErrorFlag && (self._serverErrorCode == 0);
            }
            // Выдает true когда от сервера получен ответ с кодом ошибки
            this.isServerError = function(){
                return self._isErrorFlag && (self._serverErrorCode != 0);
            }

            // Начальная загрузка
            this.load(serverApiUrl, $http, postData);
        }


        angular.module('myNgApp').controller('AnaController', function($scope, $http){

            // какие открыть в таблице
            $scope.periodCode = '{{ lka_period }}';
            $scope.anaType = '{{ lka_type }}';
            $scope.ac_is_grouping = '{{ lka_is_grouping }}' == 'True';
            $scope.ac_budget_period = '{{ lka_budget_period }}';

            $scope.lka_bperiod_choices = {{ lka_bperiod_choices_json|safe }};

            // Тут получаем с сервера данные в формате
            // pageData {
            //     'dataRows': {
            //         'rashod-week': ...
            //         'rashod-month': ...
            //         'dohod-week': ...
            //         ....
            //     },
            //     ...
            // }

            // Версия в контроллере
            $scope.acGoToAnaUrl = function(type, period, grouping_switch, bperiod){

                // Это видимо баг кода работы с чекбоксом, что инвертно работает, исправляем таким образом:
                if (grouping_switch){
                    $scope.ac_is_grouping = !$scope.ac_is_grouping;
                }

                // Возвращает строку для передачи в урл в зависимости от значения чекбокса
                var grouping = $scope.ac_is_grouping ? 'group' : '';

                // переход
                // ПЕреход на страницу анализа с указанными типом анализа, периодом, группировкой.
                // Если они не указаны (undefined), тогда взять их из УРЛ. Если в урл их нет,
                // тогда они будут по-умолчанию.
                url = window.location.href;
                if (type === undefined){
                    type = getParameterByName('lka_type', url);
                }
                if (period === undefined){
                    period = getParameterByName('lka_period', url);
                }
                if (grouping === undefined){
                    grouping = getParameterByName('lka_group', url);
                }
                if (bperiod === undefined){
                    bperiod = getParameterByName('lka_bperiod', url);
                }
                url = pvlGetUrlReplaceParam(url, 'lka_type', type, true);
                url = pvlGetUrlReplaceParam(url, 'lka_period', period, true);
                url = pvlGetUrlReplaceParam(url, 'lka_group', grouping, true);
                url = pvlGetUrlReplaceParam(url, 'lka_bperiod', bperiod, true);

                window.location.href = url;
            };

            // Загрузка данных с сервера
            $scope.load = function(){
                $scope.loader = new FromServerLoader('/ajax_lk_ana/', $http, {
                    periodCode: $scope.periodCode,
                    anaType: $scope.anaType,
                    lkax_is_grouping: $scope.ac_is_grouping,
                    lkax_bperiod: $scope.ac_budget_period
                });
            };
            $scope.load();

            $scope.getDataRowList = function(){
                return $scope.loader.api.pageData['dataRows'][$scope.anaType + '-' + $scope.periodCode]
            };
            $scope.getTotalRow = function(){
                return $scope.loader.api.pageData['totalRow'][$scope.anaType + '-' + $scope.periodCode];
            };
            $scope.getPeriods = function(){
                return $scope.loader.api.pageData['periods'][$scope.anaType + '-' + $scope.periodCode];
            };
            $scope.getSimplePageData = function(){
                return $scope.loader.api.pageData;
            };
            $scope.getCatCaption = function(){
                return "Категории";
            };
            $scope.getTotCaption = function(){
                return "Сумма";
            };
        });
    </script>

    <style>

        {# Стиль ссылки с суммы в таблице анализа #}
        .lka_sum_link{
            color: black;
        }
        .lka_sum_link:hover{
            color: red;
        }
    </style>

    <style>
        .sili_help_icon{
            display: inline-block;
            height: 18px;
            width: 18px;
            background: url(/static/img/sili_tooltip.png) no-repeat;
            position: relative;
            top: 5px;
        }
        .tooltip-inner {
            max-width: 630px;
            text-align: left;
        }
    </style>

    <div
            style="display: flex; flex-flow: row nowrap;"
            ng-controller="AnaController"
            ng-cloak
            >

        <div style="width: 320px;">

            <div style="padding: 0px 25px 25px 25px;">

                <!-- Выбор группировки -->
                <h5 style="margin: 0px 0px 0px 0px;">Анализ </h5>
                <div style="padding-bottom: 7px; display: inline-block; position: relative; top:0px;" ng-cloak>

                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: anaType=='rashod'}" ng-click="acGoToAnaUrl('rashod', undefined, undefined, undefined)">расходов</button>
                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: anaType=='dohod'}" ng-click="acGoToAnaUrl('dohod', undefined, undefined, undefined)">доходов</button>

                </div>

                <h5 style="margin: 10px 0px 0px 0px;">По периодам</h5>
                <div style="padding-bottom: 7px; display: inline-block; position: relative;" ng-cloak>

                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: periodCode=='day'}" ng-click="acGoToAnaUrl(undefined, 'day', undefined, undefined)">день</button>
                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: periodCode=='week'}" ng-click="acGoToAnaUrl(undefined, 'week', undefined, undefined)">неделя</button>
                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: periodCode=='month'}" ng-click="acGoToAnaUrl(undefined, 'month', undefined, undefined)">месяц</button>
                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: periodCode=='quart'}" ng-click="acGoToAnaUrl(undefined, 'quart', undefined, undefined)">квартал</button>
                    <button style="margin-top: 5px;" type="button" class="btn btn-default" ng-class="{active: periodCode=='app_year'}" ng-click="acGoToAnaUrl(undefined, 'app_year', undefined, undefined)">год</button>

                </div>

                <div class="form-group" style="margin: 10px 0px 0px 0px;">
                    <div class="checkbox" style="margin-top: 0px;">
                        <label>
                            <input style="position: relative; top: 3px;" type="checkbox" ng-model="ac_is_grouping" ng-click="acGoToAnaUrl(undefined, undefined, true, undefined)">
                            <span>Группировка</span>
                        </label>
                        <span ng-controller='SiliTooltipCtrl2' title='Позволяет объединить несколько категорий в таблице в одну при отображении, для облегчения анализа. Для этого в качестве названия группы берётся часть названия категории, находящаяся перед первым двойным дефисом. Например, у Вас есть категория "Еда -- Столовая" и "Еда -- Магазин". Тогда при клике на галочку эти две категории объединятся в одну с названием "Еда".' class="sili_help_icon"></span>
                    </div>
                </div>

                <h5 style="margin: 20px 0px 0px 0px;">Показать категории с периодичностью бюджета:</h5>
                <div style="padding-bottom: 7px; position: relative;" ng-cloak>

                    <button
                            style="margin-top: 5px; margin-right: 5px;"
                            ng-repeat="p in lka_bperiod_choices"
                            type="button"
                            class="btn btn-default"
                            ng-class="{ 'active': ac_budget_period == p[0] }"
                            ng-click="acGoToAnaUrl(undefined, undefined, undefined, p[0] )"
                            >
                        {$ p[1] $}
                    </button>

                </div>

            </div>
        </div>
        <div style="width: 100%; flex-grow: 1;">

            <div ng-cloak>

                <div ng-if="loader.isLoading()" class="alert alert-warning">
                    Загрузка данных с сервера, подождите, пожалуйста, до 30 секунд...
                </div>
                <div ng-if="loader.isSuccess()">

                    <!-- Таблица с периодами, категориями, суммами -->
                    <table
                            class="table table-hover table-condensed table-bordered pv_light_tooltip"
                            style="width: auto; border: none;"
                            ng-cloak
                            >
                        <thead>
                            <tr>
                                <th
                                        style="background-color: #f0f0f0; width: 200px; text-align: center; height: 75px; vertical-align: top; border-top: 1px solid #ddd;"
                                        >
                                    {$ getCatCaption() $}
                                </th>

                                {# ширина 101 подобрана чтобы недели входили, например, неделя 13 2016 года - длинный текст #}
                                <th
                                        style="background-color: #f0f0f0; width: 101px; text-align: center; height: 75px; vertical-align: top; border-top: 1px solid #ddd;"
                                        ng-repeat="p in getPeriods()"
                                        >
                                    {$ p.first $}<br /><span style="font-weight: normal;">{$ p.second $}</span>
                                </th>

                                <th style="background-color: transparent; width: 20px; border: none; height: 75px; vertical-align: top;">

                                </th>
                                <th style="background-color: #f0f0f0; width: 141px; text-align: center; height: 75px; vertical-align: top; border-top: 1px solid #ddd;">
                                    Бюджет (план) по категории
                                </th>
                                <th style="background-color: #f0f0f0; width: 141px; text-align: center; height: 75px; vertical-align: top; border-top: 1px solid #ddd;">
                                    Бюджет (план) за год
                                </th>

                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-show="getDataRowList().length == 0">
                                <td colspan="7" style="text-align: center; padding: 50px;">Нет операций для отображения.</td>
                            </tr>
                            <tr ng-repeat="row in getDataRowList()">
                                <td style="background-color: #f0f0f0; ">
                                    <div
                                            style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 200px;"
                                            pv-tooltip-directive='row.category'

                                            {# Если категория не видима то подсветка цветом #}
                                            ng-style="{'color': row.lka_is_category_visible ? 'auto' : '#dddddd'}"
                                            >
                                        {$ row.category $}
                                    </div>
                                </td>
                                <td ng-repeat="i in row.lka_cell_data track by $index" style="text-align: right;">
                                    <a
                                            href="/lk/{$ i.lka_cell_period $}/None/{$ row.lka_category_id $}/"
                                            class="lka_sum_link"

                                            {# Проход к учету возможен только без группировки #}
                                            {% if lka_is_grouping %}
                                                onclick="alert('Включена группировка. Переход к учету при клике на сумму возможен только при отключенной группировке. Отключите группировку, пожалуйста, и повторите попытку.'); return false;"
                                            {% endif %}
                                            >
                                        {$ i.lka_cell_val $}
                                    </a>
                                </td>

                                <td style="border: none;">
                                </td>
                                <td style="text-align: left;" class="{$ row.bcbci_color $}">
                                    {$ row.lka_budget_str $}
                                </td>
                                <td style="text-align: left;" class="{$ row.bcbci_year_color $}">
                                    {$ row.lka_budget_year_str $}
                                </td>

                            </tr>
                            <tr>
                                <td style="background-color: #f0f0f0; font-weight: bold; text-align: right;">
                                    <span>{$ getTotCaption() $}</span>
                                </td>
                                <td
                                        ng-repeat="i in getTotalRow() track by $index"
                                        style="background-color: #f0f0f0; text-align: right; font-weight: bold;"
                                        >
                                    {$ i $}
                                </td>

                                <td style="border: none;">
                                </td>

                                {# Итоговая сумма по всей таблице #}
                                <td style="background-color: #f0f0f0; text-align: left; font-weight: bold;">
                                    {$ getSimplePageData().pa_budget_summ $}
                                </td>
                                <td style="background-color: #f0f0f0; text-align: left; font-weight: bold;">
                                    {$ getSimplePageData().pa_budget_year_summ $}
                                </td>

                            </tr>

                            {# Итоговыве по таблице - кварт, мес, нед #}
                            <tr>
                                <td style="border: none;"></td>
                                <td ng-repeat="i in getTotalRow() track by $index" style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="background-color: #f0f0f0; text-align: left; font-weight: bold;">
                                    {$ getSimplePageData().pa_budget_quart_summ $}
                                </td>
                            </tr>
                            <tr>
                                <td style="border: none;"></td>
                                <td ng-repeat="i in getTotalRow() track by $index" style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="background-color: #f0f0f0; text-align: left; font-weight: bold;">
                                    {$ getSimplePageData().pa_budget_month_summ $}
                                </td>
                            </tr>
                            <tr>
                                <td style="border: none;"></td>
                                <td ng-repeat="i in getTotalRow() track by $index" style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="background-color: #f0f0f0; text-align: left; font-weight: bold;">
                                    {$ getSimplePageData().pa_budget_week_summ $}
                                </td>
                            </tr>
                            <tr>
                                <td style="border: none;"></td>
                                <td ng-repeat="i in getTotalRow() track by $index" style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="border: none;"></td>
                                <td style="background-color: #f0f0f0; text-align: left; font-weight: bold;">
                                    {$ getSimplePageData().pa_budget_day_summ $}
                                </td>
                            </tr>

                        </tbody>
                    </table>

                </div>
                <div ng-if="loader.isUnknownError()" class="alert alert-danger">
                    Нет связи с сервером. Повторите попытку позже, пожалуйста, или обратитесь в службу поддержки.
                </div>
                <div ng-if="loader.isServerError()" class="alert alert-danger">
                    Ошибка на сервере. Повторите попытку позже, пожалуйста, или обратитесь в службу поддержки.
                </div>

            </div>
        </div>

    </div>

{% endblock %}