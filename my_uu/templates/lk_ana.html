{% extends 'lk_base.html' %}

{% block add_to_head %}

    <!-- jqxGrid -->
    <link rel="stylesheet" href="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/styles/jqx.base.css" type="text/css" />
    <link rel="stylesheet" href="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/styles/jqx.darkblue.css" type="text/css" />
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxdata.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxmenu.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxcheckbox.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxdropdownlist.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.sort.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.pager.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.selection.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.columnsresize.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.aggregates.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxdata.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxgrid.edit.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}libs/jqwidgets-2.9.0/jqwidgets/jqxcombobox.js"></script>

    <!-- Форматирование дат -->
    <script type="text/javascript" src="{{ STATIC_URL }}libs/moment/moment.min.js"></script>

    <!-- Вспомогательные разные функции -->
    <script src="{{ STATIC_URL }}js/uu_utils.js"></script>

    <style>

        /* Переопределяем курсор над ячейками на excel-евский */
        .jqx-grid-cell {
            cursor: url("{{ STATIC_URL }}img/excel_cursor.png"), pointer;
        }

        /*
            Эти 2 стиля ставятся для ячеек если ни одной записи учета или для пустых строк под
            строками с данными. В обоих случаях курсор покажем обычный.
        */
        .jqx-grid-cleared-cell, .jqx-grid-empty-cell  {
            cursor: default;
        }

        /* Высоту заголовка меняем чтобы там номера недель и даты показывать */
        .jqx-grid-header
        {
            height: 40px !important;
        }

    </style>

{% endblock %}


{% block ana_active %} class="active"{% endblock %}

{% block lk_content %}

    <script>

        $(document).ready(function () {

            // Получаем данные с сервера и форматируем столбцы с суммами
            var data = {{ anaDataJson|safe }};
            var periods = {{ periods|safe }};
            for(var i=0; i<data.length; ++i){
                var row = data[i];
                Object.keys(row).forEach(function(k, v){
                    if (k != 'category'){
                        if (row[k] == null){
                            row[k] = 0;
                        }
                        row[k] = uuFormatCurrency(parseFloat(row[k]), false);
                    }
                })
            }

            var dataAdapter = new $.jqx.dataAdapter({
                localdata: data,
                datatype: "array"
            });

            function getCurrencyAgregatesRenderer(fieldName){
                function agregatesRenderer(){
                    var rows = $("#uuGrid").jqxGrid('getrows');
                    var agVal = 0;
                    for (var i=0; i<rows.length; ++i){
                        agVal += parseFloat(String(rows[i][fieldName]).replace('р.', '').replace(' ', ''));
                    }
                    return "<div style='padding-top: 4px; text-align: right; padding-right: 2px;'>" +
                            uuFormatCurrency(agVal, false) + "</div>";
                }
                return agregatesRenderer;
            }

            // Тут формируем набор колонок для грида - это либо номера недель либо одна длинная пустая
            // колонка если ни одной записи.
            var gridColumns = [];
            gridColumns.push({
                text: '<br />Категория',
                datafield: 'category',
                width: 175,
                pinned: true
            });
            var gridFullWidth = gridColumns[gridColumns.length-1].width;
            if (data.length == 0) {
                gridColumns.push({
                    text: '',
                    datafield: null,
                    width: 200
                });
                gridFullWidth += gridColumns[gridColumns.length-1].width;
            } else {
                fldNum = 0
                periods.forEach(function(k){
                    gridColumns.push({
                        // 'Неделя 28<br />8 - 14 июл'
                        text: k[0] + "<br />" + k[1],
                        datafield: fldNum,
                        width: 100,
                        cellsalign: 'right',
                        aggregatesrenderer: getCurrencyAgregatesRenderer(fldNum)
                    });
                    gridFullWidth += gridColumns[gridColumns.length-1].width;
                    fldNum += 1;
                });
            }

            $("#uuGrid").jqxGrid({
                theme: 'darkblue',
                width: Math.min(860, gridFullWidth),
                selectionmode: 'multiplecellsextended',
                editable: false,
                height: calGridHeight(),
                showaggregates: true,
                showstatusbar: true,
                statusbarheight: 25,
                columns: gridColumns,
                source: dataAdapter
            });

            // Ресайз грида под высоту окна (20 пикс. запас снизу для статус-строки в хроме).
            function calGridHeight(){
                return Math.max(150, $(window).height() - $("#uuGrid").offset().top - 20);
            };
            function adjustGridHeightToWindowHeight(){
                $("#uuGrid").jqxGrid({
                    height: Math.max(150, calGridHeight())
                });
            };
            adjustGridHeightToWindowHeight();
            $(window).on('resize', adjustGridHeightToWindowHeight);

            // Установка русской строки для пустого грида (вместо дефолтовой No data to display)
            uuLocalizeJqxGrid("uuGrid");
        });

    </script>

    <h5 style="display: inline;">Анализ расходов по периодам</h5>

    <!-- Выбор группировки -->
    <div style="padding-bottom: 7px; display: inline-block; position: relative; top:-4px; padding-left: 12px;">

        <label class="radio inline">
          <input type="radio" name="period" value="option1" checked="true"> по неделям
        </label>
        <label class="radio inline muted" style="margin-left: 40px;">
          <span class="mutes">скоро:</span>
        </label>
        <label class="radio inline muted">
          <input type="radio" name="period" value="option2" disabled="disabled"> по месяцам
        </label>
        <label class="radio inline muted">
          <input type="radio" name="period" value="option3" disabled="disabled"> по кварталам
        </label>
        <label class="radio inline muted">
          <input type="radio" name="period" value="option3" disabled="disabled"> по годам
        </label>

    </div>

    <div id='uuGrid' style="border: 0px;"></div>

    <script>
        function AnaController($scope){
            $scope.categoryList = ['Одежа', 'Свиданки'];
            $scope.dataList = [
                ['Одежа', '1 000 руб.', '3 000 руб.'],
                ['Свиданки', '1 000 руб.', '3 000 руб.'],
            ];
            $scope.periods = [
                {'first': 'Неделя 51', 'second': 'Хуйнаны'},
                {'first': 'Неделя 51', 'second': 'Хуйнаны'},
            ];
        }
    </script>

    <!-- Таблица с периодами, категориями, суммами
    <table class="table table-striped table-hover table-condenced" ng-controller="AnaController">
        <thead>
            <tr>
                <th>Категория</th>
                <th ng-repeat="p in periods">
                    {$ p.first $}<br />{$ p.second $}
                </th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="d in dataList">
                <td ng-repeat="i in d">{$ i $}</td>
            </tr>
        </tbody>
    </table>
    -->

{% endblock %}